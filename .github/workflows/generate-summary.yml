name: Update GitBook Summary
on:
  push:
    branches:
      - main
    paths:
      - '**/*.md'
      - '!SUMMARY.md'

permissions:
  contents: write

jobs:
  build-summary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Generate SUMMARY.md
        run: |
          echo "# Table of Contents" > SUMMARY.md
          echo "" >> SUMMARY.md
          echo "* [Introduction](README.md)" >> SUMMARY.md
          echo "" >> SUMMARY.md

          # Function to list files with custom ordering
          # Usage: list_files "Folder" "Title" "Emoji" "Pinned_File_1.md|Pinned_File_2.md"
          list_files() {
            local dir="$1"
            local title="$2"
            local emoji="$3"
            local pinned_files="$4" # Pipe-separated list of files to show first
            
            if [ -d "$dir" ]; then
              echo "## $emoji $title" >> SUMMARY.md
              
              # 1. Add the Section Overview (README) if it exists
              if [ -f "$dir/README.md" ]; then
                echo "* [$title Overview]($dir/README.md)" >> SUMMARY.md
              fi

              # 2. Add Pinned Files (in the exact order you specify)
              if [ ! -z "$pinned_files" ]; then
                # Split the pinned string by |
                IFS='|' read -ra PINNED <<< "$pinned_files"
                for filename in "${PINNED[@]}"; do
                  filepath="$dir/$filename"
                  if [ -f "$filepath" ]; then
                     clean_title=$(echo "$filename" | sed 's/.md//' | sed 's/_/ /g')
                     encoded_path=$(echo "$filepath" | sed 's/ /%20/g')
                     echo "* [$clean_title]($encoded_path)" >> SUMMARY.md
                  fi
                done
              fi

              # 3. Add the rest of the files (Alphabetical), excluding README and Pinned files
              # We construct a grep pattern to exclude the pinned files
              exclude_pattern="README.md"
              if [ ! -z "$pinned_files" ]; then
                 exclude_pattern="$exclude_pattern|$pinned_files"
              fi

              find "$dir" -maxdepth 1 -name "*.md" | sort | while read filepath; do
                filename=$(basename "$filepath")
                # Check if file matches the exclude pattern
                if ! echo "$filename" | grep -qE "^($exclude_pattern)$"; then
                  clean_title=$(echo "$filename" | sed 's/.md//' | sed 's/_/ /g')
                  encoded_path=$(echo "$filepath" | sed 's/ /%20/g')
                  echo "* [$clean_title]($encoded_path)" >> SUMMARY.md
                fi
              done
              echo "" >> SUMMARY.md
            fi
          }

          # --- CONFIGURATION AREA ---
          
          # RULES: Hunting rules first, then Character Creation
          list_files "Rules" "Rules" "üìú" "Hunting in Montreal.md|Character Creation.md"

          # LOCATIONS: Master Directory first, then Maps
          list_files "Locations" "Locations" "üó∫Ô∏è" "Locations Directory.md|Contested Locations.md"

          # COTERIES: No specific order (defaults to A-Z)
          list_files "Coteries" "Coteries" "üë•" ""
          

      - name: Commit and Push changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add SUMMARY.md
          if git diff --staged --quiet; then
            echo "No changes to SUMMARY.md"
          else
            git commit -m "ü§ñ Auto-update SUMMARY.md with custom order"
            git push
          fi